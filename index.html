
<!doctype html>
<html lang="th" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Schindler Equipment System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        schindler: { red: '#E2001A', dark: '#1A1A1A' }
                    },
                    fontFamily: { sans: ['Kanit', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F3F4F6; -webkit-tap-highlight-color: transparent; }
        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏°‡∏™‡∏ß‡∏¢ ‡πÑ‡∏°‡πà‡∏ö‡∏µ‡πâ‡πÅ‡∏ö‡∏ô */
        .btn-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .btn-icon:active { transform: scale(0.95); background-color: #374151; }
        
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .spinner { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #E2001A; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-full flex flex-col text-gray-800">

    <header class="bg-black text-white shadow-lg sticky top-0 z-40 border-b-4 border-schindler-red">
        <div class="max-w-lg mx-auto px-4 h-16 flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold tracking-wider">Schindler</h1>
                <p class="text-[10px] text-gray-400 uppercase tracking-widest">TFS Equipment</p>
            </div>
            <div class="flex gap-3">
                <button onclick="openHelp()" class="btn-icon bg-gray-800 hover:bg-gray-700 transition">
                    <span class="material-icons text-white">help_outline</span>
                </button>
                <button onclick="toggleAdmin()" class="btn-icon bg-gray-800 hover:bg-gray-700 transition">
                    <span class="material-icons text-white" id="adminIcon">admin_panel_settings</span>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-auto p-4 pb-24">
        <div class="max-w-lg mx-auto space-y-5">
            
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-xl card-shadow border-l-4 border-gray-800">
                    <span class="text-xs text-gray-500 font-bold block">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                    <span class="text-2xl font-bold" id="countTotal">0</span>
                </div>
                <div class="bg-white p-4 rounded-xl card-shadow border-l-4 border-green-500">
                    <span class="text-xs text-gray-500 font-bold block">‡∏ß‡πà‡∏≤‡∏á</span>
                    <span class="text-2xl font-bold text-green-600" id="countAvail">0</span>
                </div>
                <div class="bg-white p-4 rounded-xl card-shadow border-l-4 border-yellow-500">
                    <span class="text-xs text-gray-500 font-bold block">‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</span>
                    <span class="text-2xl font-bold text-yellow-600" id="countBorrow">0</span>
                </div>
                <div class="bg-white p-4 rounded-xl card-shadow border-l-4 border-blue-500">
                    <span class="text-xs text-gray-500 font-bold block">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                    <span class="text-2xl font-bold text-blue-600" id="countPending">0</span>
                </div>
            </div>

            <div id="adminPanel" class="hidden">
                <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
                    <div class="bg-red-50 p-3 border-b border-red-100 flex items-center gap-2">
                        <span class="material-icons text-schindler-red text-sm">notifications_active</span>
                        <span class="font-bold text-sm text-gray-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                    </div>
                    <div id="requestList" class="divide-y divide-gray-100"></div>
                    <div id="noRequestMsg" class="p-6 text-center text-gray-400 text-sm hidden">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</div>
                </div>
            </div>

            <div class="bg-white p-2 rounded-xl shadow-sm border border-gray-200 sticky top-0 z-30">
                <div class="relative mb-2">
                    <span class="material-icons absolute left-3 top-2.5 text-gray-400">search</span>
                    <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå..." 
                           class="w-full pl-10 pr-4 py-2 bg-gray-100 rounded-lg focus:ring-1 focus:ring-schindler-red outline-none text-sm transition"
                           oninput="renderGrid()">
                </div>
                <div class="flex gap-2">
                    <button onclick="filter('all')" class="flex-1 py-1.5 rounded-lg text-xs font-bold bg-gray-800 text-white transition" id="btnAll">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button onclick="filter('available')" class="flex-1 py-1.5 rounded-lg text-xs font-bold bg-gray-100 text-gray-600 transition" id="btnAvail">‡∏ß‡πà‡∏≤‡∏á</button>
                    <button onclick="filter('borrowed')" class="flex-1 py-1.5 rounded-lg text-xs font-bold bg-gray-100 text-gray-600 transition" id="btnBorrow">‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</button>
                </div>
            </div>

            <div id="grid" class="space-y-3">
                </div>
            
            <div id="loadingState" class="py-10 text-center text-gray-400 hidden">
                <div class="spinner mx-auto mb-2"></div>
                <span class="text-xs">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
            </div>
        </div>
    </main>

    <button id="addBtn" onclick="openUpsert()" class="hidden fixed bottom-6 right-6 w-14 h-14 bg-schindler-red text-white rounded-full shadow-xl flex items-center justify-center z-40 active:scale-90 transition">
        <span class="material-icons text-3xl">add</span>
    </button>

    <div id="actionModal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-end md:items-center justify-center">
        <div class="bg-white w-full md:max-w-md rounded-t-2xl md:rounded-2xl p-6 animate-slide-up max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-1" id="actTitle">Title</h3>
            <p class="text-xs text-gray-500 mb-4 bg-gray-100 p-2 rounded" id="actSub">Detail</p>
            
            <form onsubmit="event.preventDefault(); submitAction();">
                <div id="borrowerGroup" class="mb-4">
                    <label class="text-xs font-bold text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</label>
                    <input type="text" id="actName" class="w-full mt-1 p-3 border rounded-lg focus:border-schindler-red outline-none bg-gray-50" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
                </div>

                <div class="mb-6">
                    <label class="text-xs font-bold text-gray-500 uppercase block mb-2">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label>
                    
                    <div id="actPreviewBox" class="hidden mb-2 relative rounded-lg overflow-hidden border border-gray-300 bg-gray-100 h-48">
                        <img id="actPreview" class="w-full h-full object-contain">
                        <button type="button" onclick="clearImage('act')" class="absolute top-2 right-2 bg-red-600 text-white rounded-full p-1 shadow">
                            <span class="material-icons text-sm block">close</span>
                        </button>
                    </div>

                    <label class="flex flex-col items-center justify-center h-24 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                        <span class="material-icons text-gray-400">camera_alt</span>
                        <span class="text-xs text-gray-500 mt-1">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</span>
                        <input type="file" id="actFile" accept="image/*" class="hidden" onchange="handleImage(this, 'actPreview', 'actPreviewBox')">
                    </label>
                </div>

                <div class="flex gap-3">
                    <button type="button" onclick="closeModal('actionModal')" class="flex-1 py-3 bg-gray-200 rounded-lg font-bold text-gray-700">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="flex-1 py-3 bg-schindler-red text-white rounded-lg font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loginModal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h3 class="text-xl font-bold text-center mb-6">Admin Login</h3>
            <form onsubmit="event.preventDefault(); doLogin();">
                <div class="relative mb-4">
                    <input type="password" id="loginPass" class="w-full p-3 pr-10 border rounded-lg focus:border-schindler-red outline-none text-center tracking-widest" placeholder="Passcode">
                    <button type="button" onclick="togglePass()" class="absolute right-3 top-3 text-gray-400">
                        <span class="material-icons" id="eyeIcon">visibility</span>
                    </button>
                </div>
                <button type="submit" class="w-full py-3 bg-black text-white rounded-lg font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button type="button" onclick="closeModal('loginModal')" class="w-full mt-3 py-2 text-gray-400 text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </form>
        </div>
    </div>

    <div id="upsertModal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-end md:items-center justify-center">
        <div class="bg-white w-full md:max-w-md rounded-t-2xl md:rounded-2xl p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4" id="upTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
            <form onsubmit="event.preventDefault(); submitUpsert();">
                <input type="hidden" id="upMode" value="add">
                
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">‡∏£‡∏´‡∏±‡∏™ (Auto)</label>
                        <input type="text" id="upId" class="w-full mt-1 p-3 bg-gray-100 border rounded-lg text-gray-500" readonly>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
                        <input type="text" id="upName" class="w-full mt-1 p-3 border rounded-lg focus:border-schindler-red outline-none" required>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                        <select id="upType" class="w-full mt-1 p-3 border rounded-lg bg-white">
                            <option value="General">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                            <option value="Power Tool">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</option>
                            <option value="Safety">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</option>
                            <option value="IT">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏≠‡∏ó‡∏µ</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                        <div id="upPreviewBox" class="hidden mb-2 relative rounded-lg overflow-hidden border border-gray-300 bg-gray-100 h-48">
                            <img id="upPreview" class="w-full h-full object-contain">
                            <button type="button" onclick="clearImage('up')" class="absolute top-2 right-2 bg-red-600 text-white rounded-full p-1 shadow">
                                <span class="material-icons text-sm block">close</span>
                            </button>
                        </div>
                        <label class="flex flex-col items-center justify-center h-20 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                            <span class="material-icons text-gray-400">add_photo_alternate</span>
                            <span class="text-xs text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
                            <input type="file" id="upFile" accept="image/*" class="hidden" onchange="handleImage(this, 'upPreview', 'upPreviewBox')">
                        </label>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button type="button" onclick="closeModal('upsertModal')" class="flex-1 py-3 bg-gray-200 rounded-lg font-bold text-gray-700">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="flex-1 py-3 bg-schindler-red text-white rounded-lg font-bold shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <div id="helpModal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-0 overflow-hidden shadow-2xl">
            <div class="bg-black p-4 flex justify-between items-center text-white">
                <span class="font-bold flex items-center gap-2"><span class="material-icons text-sm">menu_book</span> ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                <button onclick="closeModal('helpModal')"><span class="material-icons">close</span></button>
            </div>
            <div class="p-5 max-h-[60vh] overflow-y-auto text-sm space-y-4">
                <div>
                    <h4 class="font-bold text-schindler-red mb-1">üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h4>
                    <ul class="list-disc pl-5 text-gray-600 space-y-1">
                        <li><b>‡∏¢‡∏∑‡∏°‡∏Ç‡∏≠‡∏á:</b> ‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î (‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß) > ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ > ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ > ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</li>
                        <li><b>‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á:</b> ‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î (‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á) > ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ > ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</li>
                        <li>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤ Admin ‡∏à‡∏∞‡∏Å‡∏î‡∏£‡∏±‡∏ö</li>
                    </ul>
                </div>
                <div class="border-t pt-3">
                    <h4 class="font-bold text-black mb-1">üõ°Ô∏è Admin</h4>
                    <ul class="list-disc pl-5 text-gray-600 space-y-1">
                        <li><b>Login:</b> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏•‡πà > ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</li>
                        <li><b>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡∏Å‡∏î ‚úì ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡∏´‡∏£‡∏∑‡∏≠ ‚úï ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</li>
                        <li><b>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á:</b> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° + ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á</li>
                        <li><b>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö:</b> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏¥‡∏ô‡∏™‡∏≠/‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞ ‡∏ö‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="busyOverlay" class="fixed inset-0 z-[100] bg-white/90 flex flex-col items-center justify-center hidden">
        <div class="spinner border-t-schindler-red mb-3"></div>
        <p class="text-sm font-bold text-gray-600 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        <p class="text-xs text-gray-400 mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
    </div>

    <script>
        // ==========================================
        // üîß ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!) ‡πÉ‡∏™‡πà URL Web App ‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        // ==========================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbzIFzCuFE-WTS8kRnyvz8DaqNMbexgTxO2MIWBzT3ipYJxUOtzm2yVQn95kqhqdo4Hl/exec'; 
        const ADMIN_CODE = 'jiraphong2227';
        // ==========================================

        let items = [];
        let filterType = 'all';
        let isAdmin = false;
        let selectedItem = null;

        // --- Init ---
        document.addEventListener('DOMContentLoaded', loadData);

        // --- Core Functions ---
        async function loadData() {
            document.getElementById('loadingState').classList.remove('hidden');
            try {
                // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö POST ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á Cache
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'read' })
                });
                const data = await res.json();
                
                if (data.status === 'error') throw new Error(data.message);
                
                items = Array.isArray(data) ? data : [];
                render();
            } catch (err) {
                console.error(err);
                alert("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + err.message + "\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
            } finally {
                document.getElementById('loadingState').classList.add('hidden');
            }
        }

        async function postData(payload) {
            document.getElementById('busyOverlay').classList.remove('hidden');
            try {
                // Payload ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô JSON string
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    await loadData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                    return true;
                } else {
                    throw new Error(data.message);
                }
            } catch (err) {
                console.error(err);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
                return false;
            } finally {
                document.getElementById('busyOverlay').classList.add('hidden');
            }
        }

        // --- UI Rendering ---
        function render() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            // Stats
            document.getElementById('countTotal').innerText = items.length;
            document.getElementById('countAvail').innerText = items.filter(x => x.status === 'available').length;
            document.getElementById('countBorrow').innerText = items.filter(x => x.status !== 'available').length;
            document.getElementById('countPending').innerText = items.filter(x => x.status.includes('pending')).length;

            // Admin Requests
            if (isAdmin) renderAdminRequests();

            // Filter
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = items.filter(x => {
                const matchText = x.name.toLowerCase().includes(term) || x.id.toLowerCase().includes(term);
                let matchType = true;
                if (filterType === 'available') matchType = x.status === 'available';
                if (filterType === 'borrowed') matchType = x.status !== 'available';
                return matchText && matchType;
            });

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="text-center text-gray-400 py-10 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                return;
            }

            filtered.forEach(x => {
                const isAvail = x.status === 'available';
                const statusMap = {
                    'available': { t: '‡∏ß‡πà‡∏≤‡∏á', c: 'bg-green-100 text-green-700' },
                    'borrowed': { t: '‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°', c: 'bg-yellow-100 text-yellow-700' },
                    'pending_borrow': { t: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', c: 'bg-blue-100 text-blue-700' },
                    'pending_return': { t: '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', c: 'bg-purple-100 text-purple-700' }
                };
                const st = statusMap[x.status] || { t: x.status, c: 'bg-gray-100' };

                let adminTools = '';
                if (isAdmin) {
                    adminTools = `
                        <div class="absolute top-2 right-2 flex gap-1 z-10">
                            <button onclick="event.stopPropagation(); editItem('${x.id}')" class="bg-white p-1.5 rounded-full shadow text-blue-600"><span class="material-icons text-sm">edit</span></button>
                            <button onclick="event.stopPropagation(); deleteItem('${x.id}')" class="bg-white p-1.5 rounded-full shadow text-red-600"><span class="material-icons text-sm">delete</span></button>
                        </div>
                    `;
                }

                const imgHtml = x.photoUrl ? 
                    `<img src="${x.photoUrl}" class="w-full h-full object-cover">` : 
                    `<div class="w-full h-full flex items-center justify-center bg-gray-200"><span class="material-icons text-gray-400">image</span></div>`;

                grid.innerHTML += `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex h-28 relative active:scale-[0.99] transition" onclick="clickItem('${x.id}')">
                        ${adminTools}
                        <div class="w-28 bg-gray-100 flex-shrink-0">
                            ${imgHtml}
                        </div>
                        <div class="flex-1 p-3 flex flex-col justify-between">
                            <div>
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-[10px] text-gray-400 font-mono tracking-wider">${x.id}</span>
                                    <span class="text-[10px] px-2 py-0.5 rounded-full ${st.c} font-bold">${st.t}</span>
                                </div>
                                <h4 class="font-bold text-gray-800 text-sm line-clamp-2 leading-tight">${x.name}</h4>
                            </div>
                            ${!isAvail ? `<div class="text-xs text-gray-500 flex items-center gap-1"><span class="material-icons text-[12px]">person</span> ${x.borrower}</div>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        function renderAdminRequests() {
            const list = document.getElementById('requestList');
            const box = document.getElementById('adminPanel');
            const noMsg = document.getElementById('noRequestMsg');
            
            list.innerHTML = '';
            const pendings = items.filter(x => x.status.includes('pending'));
            
            box.classList.remove('hidden');
            if (pendings.length === 0) {
                noMsg.classList.remove('hidden');
                return;
            }
            noMsg.classList.add('hidden');

            pendings.forEach(x => {
                const isBorrow = x.status === 'pending_borrow';
                const typeText = isBorrow ? '‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å' : '‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏∑‡∏ô';
                const typeColor = isBorrow ? 'text-blue-600' : 'text-purple-600';
                
                list.innerHTML += `
                    <div class="p-3 bg-white">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold ${typeColor}">${typeText}</span>
                            <span class="text-xs text-gray-400">${x.id}</span>
                        </div>
                        <div class="font-bold text-sm text-gray-800">${x.name}</div>
                        <div class="text-xs text-gray-500 mb-2">‡πÇ‡∏î‡∏¢: ${x.borrower}</div>
                        ${x.photoUrl ? `<a href="${x.photoUrl}" target="_blank" class="text-xs text-blue-500 underline mb-2 block">‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</a>` : ''}
                        <div class="flex gap-2">
                            <button onclick="approve('${x.id}', '${isBorrow?'borrow':'return'}')" class="flex-1 bg-green-600 text-white text-xs py-1.5 rounded font-bold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                            <button onclick="reject('${x.id}', '${isBorrow?'borrow':'return'}')" class="flex-1 bg-gray-200 text-gray-600 text-xs py-1.5 rounded font-bold">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                        </div>
                    </div>
                `;
            });
        }

        // --- Interaction ---
        function clickItem(id) {
            if (isAdmin) return; 
            const item = items.find(x => x.id === id);
            selectedItem = item;

            if (item.status.includes('pending')) {
                alert('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¢‡∏π‡πà ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ');
                return;
            }

            document.getElementById('actName').value = '';
            clearImage('act');
            
            const title = document.getElementById('actTitle');
            const sub = document.getElementById('actSub');
            const grp = document.getElementById('borrowerGroup');
            const nameInp = document.getElementById('actName');

            sub.innerText = `${item.id} - ${item.name}`;

            if (item.status === 'available') {
                title.innerText = '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå';
                grp.classList.remove('hidden');
                nameInp.required = true;
            } else {
                title.innerText = '‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå';
                
grp.classList.add('hidden');
                nameInp.required = false;
            }

            openModal('actionModal');
        }

        async function submitAction() {
            closeModal('actionModal');
            const type = selectedItem.status === 'available' ? 'borrow' : 'return';
            // ‡πÉ‡∏ä‡πâ getCompressedBase64 ‡πÅ‡∏ó‡∏ô getBase64 ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
            const imgData = await getCompressedBase64('actFile');

            await postData({
                action: type,
                id: selectedItem.id,
                borrower: document.getElementById('actName').value,
                imageData: imgData?.data,
                imageName: imgData?.name
            });
        }

        // --- Admin Functions ---
        function toggleAdmin() {
            if (isAdmin) {
                isAdmin = false;
                document.getElementById('addBtn').classList.add('hidden');
                document.getElementById('adminPanel').classList.add('hidden');
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏Å‡∏•‡∏±‡∏ö
                document.getElementById('adminIcon').parentElement.classList.remove('bg-schindler-red');
                render();
            } else {
                openModal('loginModal');
            }
        }

        function doLogin() {
            const pass = document.getElementById('loginPass').value;
            if (pass === ADMIN_CODE) {
                isAdmin = true;
                closeModal('loginModal');
                document.getElementById('addBtn').classList.remove('hidden');
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤ Login ‡∏≠‡∏¢‡∏π‡πà
                document.getElementById('adminIcon').parentElement.classList.add('bg-schindler-red');
                document.getElementById('loginPass').value = '';
                render();
            } else {
                alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }
        }

        function openUpsert() {
            document.getElementById('upTitle').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('upMode').value = 'add';
            document.getElementById('upName').value = '';
            clearImage('up');
            
            const maxId = items.reduce((max, x) => {
                const num = parseInt(x.id.replace('TFS-', '')) || 0;
                return Math.max(max, num);
            }, 0);
            document.getElementById('upId').value = `TFS-${String(maxId + 1).padStart(3, '0')}`;
            
            openModal('upsertModal');
        }

        function editItem(id) {
            const item = items.find(x => x.id === id);
            document.getElementById('upTitle').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            document.getElementById('upMode').value = 'edit';
            document.getElementById('upId').value = item.id;
            document.getElementById('upName').value = item.name;
            document.getElementById('upType').value = item.type;
            clearImage('up'); 
            openModal('upsertModal');
        }

        async function submitUpsert() {
            closeModal('upsertModal');
            const imgData = await getCompressedBase64('upFile');
            
            await postData({
                action: document.getElementById('upMode').value,
                id: document.getElementById('upId').value,
                name: document.getElementById('upName').value,
                type: document.getElementById('upType').value,
                imageData: imgData?.data,
                imageName: imgData?.name
            });
        }

        async function deleteItem(id) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                await postData({ action: 'delete', id: id });
            }
        }

        async function approve(id, type) {
            await postData({ action: 'approve', id: id, reqType: type });
        }

        async function reject(id, type) {
            if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ?')) {
                await postData({ action: 'reject', id: id, reqType: type });
            }
        }

        // --- Utilities & Helper Functions ---
        
        function filter(type) {
            filterType = type;
            ['btnAll', 'btnAvail', 'btnBorrow'].forEach(id => {
                const btn = document.getElementById(id);
                btn.className = 'flex-1 py-1.5 rounded-lg text-xs font-bold bg-gray-100 text-gray-600 transition';
            });
            const active = type === 'all' ? 'btnAll' : (type === 'available' ? 'btnAvail' : 'btnBorrow');
            document.getElementById(active).className = 'flex-1 py-1.5 rounded-lg text-xs font-bold bg-gray-800 text-white transition shadow';
            render();
        }

        function handleImage(input, imgId, boxId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(imgId).src = e.target.result;
                    document.getElementById(boxId).classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearImage(prefix) {
            document.getElementById(prefix + 'File').value = '';
            document.getElementById(prefix + 'PreviewBox').classList.add('hidden');
            document.getElementById(prefix + 'Preview').src = '';
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!) ---
        function getCompressedBase64(inputId) {
            const input = document.getElementById(inputId);
            if (!input.files || !input.files[0]) return Promise.resolve(null);
            
            const file = input.files[0];
            const maxWidth = 800; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 800px (‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡∏°‡∏≤‡∏Å)
            
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô JPEG ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 0.7
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve({ name: file.name, data: dataUrl });
                    };
                };
            });
        }

        function togglePass() {
            const inp = document.getElementById('loginPass');
            const icon = document.getElementById('eyeIcon');
            if (inp.type === 'password') {
                inp.type = 'text';
                icon.innerText = 'visibility_off';
            } else {
                inp.type = 'password';
                icon.innerText = 'visibility';
            }
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openHelp() { openModal('helpModal'); }

    </script>
</body>
</html>
